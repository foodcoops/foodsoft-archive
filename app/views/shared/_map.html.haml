%div{style: "width: #{width rescue '800px'}"}
  %div#map{style: "width: #{width rescue '800px'}; height: #{height rescue '600px'};"}

= javascript_include_tag '//maps.google.com/maps/api/js?v=3.13&sensor=false&libraries=geometry'
= javascript_include_tag '//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js'
- marker_data = Gmaps4rails.build_markers(objects) {|o,marker| marker.lat o.latitude; marker.lng o.longitude}
- map_opts = {internal: {id: 'map'}}
- zoom ||= nil
- map_opts[:provider] = {zoom: zoom} if zoom
:javascript
  $(function() {
    handler = Gmaps.build('Google');
    handler.buildMap(#{raw map_opts.to_json}, function() {
      markers = handler.addMarkers(#{raw marker_data.to_json});
      handler.bounds.extendWith(markers);
      handler.fitMapToBounds();
      #{"handler.getMap().setZoom(#{zoom});" if zoom}
    });
  });
